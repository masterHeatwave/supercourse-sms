<p-toast></p-toast>

<div class="board-container p-4">
  <!-- Header -->
  <div class="flex justify-content-between align-items-center mb-4">
    <h1 class="text-3xl font-bold text-primary m-0">{{ 'board.title' | translate }}</h1>
    <div class="flex gap-2 align-items-center">
      <!-- Create Post Button -->
      <p-button 
        [label]="'board.create.button' | translate" 
        icon="pi pi-plus" 
        severity="success"
        routerLink="/dashboard/board/create"
      ></p-button>
      
      <!-- View Mode Toggle -->
      <div class="flex border-round border-1 border-300">
        <button 
          *ngFor="let mode of viewModes"
          [class]="'p-button p-button-text border-none ' + (currentViewMode === mode.value ? 'bg-primary text-white' : 'text-700')"
          (click)="setViewMode(mode.value)"
        >
          <i [class]="mode.icon"></i>
        </button>
      </div>
      
      <!-- Sort By -->
      <p-dropdown 
        [options]="sortOptions" 
        [(ngModel)]="selectedSort" 
        [placeholder]="'board.sort.placeholder' | translate"
        (onChange)="onSortChange()"
        styleClass="w-auto"
      >
        <ng-template let-item pTemplate="item">
          {{ item.label | translate }}
        </ng-template>
        <ng-template pTemplate="selectedItem" let-selected>
          {{ selected?.label | translate }}
        </ng-template>
      </p-dropdown>
      
      <!-- Export Button -->
      <p-button 
        icon="pi pi-download" 
        severity="secondary" 
        (onClick)="exportPosts()"
        [outlined]="true"
      ></p-button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="custom-card p-3 mb-4">
    <div class="flex flex-wrap gap-3 align-items-end">
      <!-- View Filter -->
      <div class="flex flex-column">
        <label class="text-sm font-medium text-700 mb-1">{{ 'board.filters.view' | translate }}</label>
        <p-dropdown 
          [options]="creatorOptions" 
          [(ngModel)]="filters.creator" 
          optionValue="value"
          (onChange)="onFilterChange()"
          styleClass="w-9rem"
        >
          <ng-template let-item pTemplate="item">
            {{ item.labelKey ? (item.labelKey | translate) : item.label }}
          </ng-template>
          <ng-template pTemplate="selectedItem" let-selected>
            {{ selected?.labelKey ? (selected.labelKey | translate) : selected?.label }}
          </ng-template>
        </p-dropdown>
      </div>

      <!-- Priority Filter -->
      <div class="flex flex-column">
        <label class="text-sm font-medium text-700 mb-1">{{ 'board.filters.priority' | translate }}</label>
        <p-dropdown 
          [options]="priorityOptions" 
          [(ngModel)]="filters.priority" 
          optionValue="value"
          (onChange)="onFilterChange()"
          styleClass="w-9rem"
        >
          <ng-template let-item pTemplate="item">
            {{ item.labelKey ? (item.labelKey | translate) : item.label }}
          </ng-template>
          <ng-template pTemplate="selectedItem" let-selected>
            {{ selected?.labelKey ? (selected.labelKey | translate) : selected?.label }}
          </ng-template>
        </p-dropdown>
      </div>

      <!-- Date Range -->
      <div class="flex flex-column">
        <label class="text-sm font-medium text-700 mb-1">{{ 'board.filters.date' | translate }}</label>
        <div class="flex gap-2">
          <p-calendar 
            [(ngModel)]="filters.dateFrom" 
            [placeholder]="'board.filters.from' | translate"
            dateFormat="dd/mm/yy"
            (onSelect)="onFilterChange()"
            styleClass="w-8rem"
          ></p-calendar>
          <p-calendar 
            [(ngModel)]="filters.dateTo" 
            [placeholder]="'board.filters.to' | translate"
            dateFormat="dd/mm/yy"
            (onSelect)="onFilterChange()"
            styleClass="w-8rem"
          ></p-calendar>
        </div>
      </div>

      <!-- Academic Period -->
      <div class="flex flex-column">
        <label class="text-sm font-medium text-700 mb-1">{{ 'board.filters.academic_period' | translate }}</label>
        <p-dropdown 
          [options]="academicPeriodOptions" 
          [(ngModel)]="filters.academicPeriod" 
          optionValue="value"
          (onChange)="onFilterChange()"
          styleClass="w-9rem"
        >
          <ng-template let-item pTemplate="item">
            {{ item.labelKey ? (item.labelKey | translate) : item.label }}
          </ng-template>
          <ng-template pTemplate="selectedItem" let-selected>
            {{ selected?.labelKey ? (selected.labelKey | translate) : selected?.label }}
          </ng-template>
        </p-dropdown>
      </div>

      <!-- Clear Filters Button -->
      <div>
        <p-button 
          [label]="'common.clear' | translate" 
          icon="pi pi-times" 
          severity="secondary" 
          (onClick)="clearFilters()"
          [outlined]="true"
          size="small"
        ></p-button>
      </div>
    </div>
  </div>

  <!-- Pinned Posts Section -->
  <div class="custom-card p-4 mb-4" *ngIf="pinnedPosts.length > 0">
    <h2 class="text-2xl font-bold text-primary mb-3">{{ 'board.sections.pinned' | translate }}</h2>
    
    <!-- Loading indicator for pinned posts -->
    <div *ngIf="loadingPosts" class="flex justify-content-center p-4">
      <i class="pi pi-spin pi-spinner text-primary text-4xl"></i>
    </div>

    <!-- Pinned posts grid -->
    <div *ngIf="!loadingPosts" class="grid">
      <div class="col-12 md:col-6 lg:col-4" *ngFor="let post of pinnedPosts">
        <div class="relative">
          <!-- Pin indicator -->
          <div class="absolute top-0 right-0 bg-primary text-white border-circle p-2 m-2 z-1">
            <i class="pi pi-thumbtack text-xs"></i>
          </div>
          <!-- Edit button overlay -->
          <button
            type="button"
            class="absolute top-0 left-0 m-2 p-button p-button-rounded p-button-text z-2"
            (click)="$event.stopPropagation(); editPost(post.id)"
            [title]="'board.tooltips.edit_post' | translate"
          >
            <i class="pi pi-pencil"></i>
          </button>
          <!-- Clickable card -->
          <div (click)="goToPost(post.id)" class="cursor-pointer">
            <app-post-card
              [title]="post.title"
              [content]="post.content"
              [date]="formatDate(post.published_at || post.createdAt)"
              [postImage]="post.featured_image || defaultPostImage"
              [avatarImage]="'assets/images/avatar.jpg'"
              [author]="post.authorName"
              [tags]="post.tags"
              [isPinned]="true"
            ></app-post-card>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Other Posts Section -->
  <div class="custom-card p-4 mb-4">
    <h2 class="text-2xl font-bold text-primary mb-3">{{ 'board.sections.other' | translate }}</h2>

    <!-- Loading indicator -->
    <div *ngIf="loadingPosts" class="flex justify-content-center p-4">
      <i class="pi pi-spin pi-spinner text-primary text-4xl"></i>
    </div>

    <!-- No posts message -->
    <div *ngIf="!loadingPosts && posts.length === 0" class="flex justify-content-center p-4">
      <p class="text-lg text-500">{{ 'board.no_posts' | translate }}</p>
    </div>

    <!-- Posts grid view -->
    <div *ngIf="!loadingPosts && posts.length > 0 && currentViewMode === 'grid'" class="grid">
      <div class="col-12 md:col-6 lg:col-4" *ngFor="let post of posts">
        <div class="relative">
          <!-- Edit button overlay -->
          <button
            type="button"
            class="absolute top-0 left-0 m-2 p-button p-button-rounded p-button-text z-2"
            (click)="$event.stopPropagation(); editPost(post.id)"
            [title]="'board.tooltips.edit_post' | translate"
          >
            <i class="pi pi-pencil"></i>
          </button>
          <!-- Clickable card -->
          <div (click)="goToPost(post.id)" class="cursor-pointer">
            <app-post-card
              [title]="post.title"
              [content]="post.content"
              [date]="formatDate(post.published_at || post.createdAt)"
              [postImage]="post.featured_image || defaultPostImage"
              [avatarImage]="'assets/images/avatar.jpg'"
              [author]="post.authorName"
              [tags]="post.tags"
              [isPinned]="false"
            ></app-post-card>
          </div>
        </div>
      </div>
    </div>

    <!-- Posts list view -->
    <div *ngIf="!loadingPosts && posts.length > 0 && currentViewMode === 'list'" class="flex flex-column gap-3">
      <div *ngFor="let post of posts" class="border-1 border-200 border-round p-3 relative">
        <!-- Edit button overlay -->
        <button
          type="button"
          class="absolute top-0 left-0 m-2 p-button p-button-rounded p-button-text z-2"
          (click)="$event.stopPropagation(); editPost(post.id)"
          title="Edit post"
        >
          <i class="pi pi-pencil"></i>
        </button>
        <div class="flex gap-3 cursor-pointer" (click)="goToPost(post.id)">
          <img 
            [src]="post.featured_image || defaultPostImage" 
            alt="Post image" 
            class="w-6rem h-4rem object-fit-cover border-round"
          />
          <div class="flex-1">
            <h3 class="text-xl font-bold text-primary m-0 mb-2">{{ post.title }}</h3>
            <p class="text-sm text-700 mb-2 line-height-3">{{ post.content }}</p>
            <div class="flex justify-content-between align-items-center">
              <div class="flex align-items-center gap-2">
                <span class="text-xs text-500">{{ post.authorName }}</span>
                <span class="text-xs text-500">â€¢</span>
                <span class="text-xs text-500">{{ formatDate(post.published_at || post.createdAt) }}</span>
              </div>
              <div class="flex gap-1" *ngIf="post.tags && post.tags.length > 0">
                <span 
                  *ngFor="let tag of post.tags.slice(0, 3)" 
                  class="bg-primary text-white text-xs px-2 py-1 border-round"
                >
                  {{ tag }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div *ngIf="!loadingPosts && posts.length > 0" class="mt-4">
      <p-paginator
        [rows]="pageSize"
        [totalRecords]="totalRecords"
        [first]="first"
        [rowsPerPageOptions]="[9, 18, 27]"
        (onPageChange)="onPageChange($event)"
        styleClass="custom-paginator"
      ></p-paginator>
    </div>
  </div>
</div>
