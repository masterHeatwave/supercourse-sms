<p-toast></p-toast>

<p-confirmDialog #cd [dismissableMask]="true" [style]="{width: '450px'}">
  <ng-template pTemplate="headless" let-message>
    <div class="flex flex-column align-items-center p-5 surface-overlay border-round-xl">
      <div class="border-circle bg-red-100 inline-flex justify-content-center align-items-center h-6rem w-6rem -mt-4">
        <i class="pi pi-exclamation-triangle text-5xl text-red-500"></i>
      </div>
      <span class="font-bold text-2xl block mb-2 mt-4 text-900">
        {{ message.header }}
      </span>
      <p class="mb-0 text-600 text-center line-height-3">{{ message.message }}</p>
      <div class="flex align-items-center gap-3 mt-5">
        <p-button 
          [label]="'common.cancel' | translate" 
          icon="pi pi-times"
          severity="secondary" 
          size="large"
          [style]="{'min-width': '120px'}"
          (click)="cd.reject()" />
        <p-button 
          [label]="'common.delete' | translate" 
          icon="pi pi-trash"
          severity="danger" 
          size="large"
          [style]="{'min-width': '120px'}"
          (click)="cd.accept()" />
      </div>
    </div>
  </ng-template>
</p-confirmDialog>

<ng-container>
  <div class="flex flex-column gap-4 px-4">
    <div
      class="flex justify-content-between align-items-center mb-3 mt-3"
      *ngIf="!isLoading && allItems.length > 0"
    >
      <div class="flex align-items-center gap-2">
        <input 
          type="text" 
          pInputText 
          [(ngModel)]="searchTerm" 
          (input)="onSearchInput($event)"
          placeholder="{{ 'common.search' | translate }}"
          class="w-20rem" />
        <p-button 
          icon="pi pi-search" 
          styleClass="p-button-text" 
          (onClick)="onSearch()">
        </p-button>
      </div>
      
      <!-- Action Buttons Section -->
      <div class="flex gap-3 align-items-center">
        <!-- Add Button -->
        <button 
          class="icon-only-button"
          (click)="navigateToCreate()"
        >
          <i class="pi pi-plus"></i>
        </button>
        
        <!-- View Mode Toggle -->
        <div class="flex gap-2">
          <button 
            *ngFor="let mode of viewModes"
            class="icon-only-button"
            [class.active]="currentViewMode === mode.value"
            (click)="setViewMode(mode.value)"
          >
            <i [class]="mode.icon"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="card position-relative">
      <app-spinner *ngIf="isLoading" [overlay]="true"></app-spinner>

      <app-primary-table
        *ngIf="currentViewMode === 'list' && items.length > 0"
        [data]="items"
        [columns]="tableColumns"
        [rows]="10"
        [totalRecords]="totalRecords"
        [viewMode]="'list'"
        (pageChange)="onPageChange($event)"
        (rowsPerPageChange)="onRowsPerPageChange($event)"
        (rowSelect)="onRowSelect($event)"
        (editRow)="onEdit($event)"
        (viewRow)="onRowSelect($event)"
        (deleteRow)="onDelete($event)"
        [dataKey]="'id'"
      >
      </app-primary-table>

      <div
        *ngIf="
          currentViewMode === 'list' &&
          !isLoading &&
          items.length === 0
        "
        class="flex flex-column align-items-center justify-content-center py-8"
      >
        <div class="text-center mb-4">
          <i class="pi pi-book text-6xl text-300 mb-3"></i>
          <h2 class="text-2xl font-bold text-700 mb-2">
            No books found
          </h2>
          <p class="text-600 mb-4">
            Add your first book to get started
          </p>
        </div>
        <p-button 
          label="Add book"
          icon="pi pi-plus" 
          (onClick)="navigateToCreate()"
          styleClass="p-button-lg">
        </p-button>
      </div>
      
      <!-- Grid view -->
      <div *ngIf="currentViewMode === 'grid' && !isLoading && items.length > 0" class="grid mt-3">
        <div class="col-12 md:col-6 lg:col-4" *ngFor="let item of items">
          <p-card 
            styleClass="inventory-card"
          >
            <div class="flex flex-column gap-3" (click)="onRowSelect(item)" style="cursor: pointer;">
              <!-- Header Section -->
              <div class="flex flex-column gap-2">
                <h3 class="text-xl font-bold text-primary m-0">{{ item.title }}</h3>
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-hashtag text-primary text-sm"></i>
                  <span class="text-sm text-500">{{ 'inventory.table.code' | translate }}:</span>
                  <span class="text-sm font-semibold text-900">{{ item.code || '-' }}</span>
                </div>
              </div>
              
              <!-- Details Section -->
              <div class="flex flex-column gap-2 pt-3 border-top-1 surface-border">
                <div class="flex align-items-center gap-2 py-1">
                  <i class="pi pi-user text-primary"></i>
                  <span class="text-sm text-600 flex-1">{{ 'inventory.table.borrower' | translate }}:</span>
                  <span class="text-sm font-semibold text-900">{{ item.billing_person || '-' }}</span>
                </div>
                <div class="flex align-items-center gap-2 py-1">
                  <i class="pi pi-calendar text-primary"></i>
                  <span class="text-sm text-600 flex-1">{{ 'inventory.table.billingDate' | translate }}:</span>
                  <span class="text-sm font-semibold text-900">{{ formatDate(item.billing_date) }}</span>
                </div>
                <div class="flex align-items-center gap-2 py-1">
                  <i class="pi pi-calendar text-primary"></i>
                  <span class="text-sm text-600 flex-1">{{ 'inventory.table.returnDate' | translate }}:</span>
                  <span class="text-sm font-semibold text-900">{{ formatDate(item.return_date) }}</span>
                </div>
              </div>
            </div>
            <ng-template pTemplate="footer">
              <div class="flex justify-content-end gap-2 pt-2">
                <!-- Edit button -->
                <button
                  pButton
                  type="button"
                  class="p-button-text p-button-sm"
                  icon="pi pi-pencil"
                  (click)="$event.stopPropagation(); onEdit(item)"
                  [pTooltip]="'common.edit' | translate"
                  [label]="'common.edit' | translate"
                ></button>
                <!-- Delete button -->
                <button
                  pButton
                  type="button"
                  class="p-button-text p-button-sm p-button-danger"
                  icon="pi pi-trash"
                  (click)="$event.stopPropagation(); onDelete(item)"
                  [pTooltip]="'common.delete' | translate"
                  [label]="'common.delete' | translate"
                ></button>
              </div>
            </ng-template>
          </p-card>
        </div>
      </div>
      
      <!-- Empty state for grid view -->
      <div *ngIf="currentViewMode === 'grid' && !isLoading && items.length === 0" class="flex flex-column align-items-center justify-content-center p-6">
        <i class="pi pi-book text-6xl text-400 mb-4"></i>
        <p class="text-xl text-500">{{ 'common.no_data' | translate }}</p>
      </div>
      
      <!-- Pagination for grid view -->
      <div *ngIf="currentViewMode === 'grid' && !isLoading && totalRecords > 0" class="mt-4">
        <p-paginator
          [rows]="rowsPerPage"
          [totalRecords]="totalRecords"
          [first]="(currentPage - 1) * rowsPerPage"
          [rowsPerPageOptions]="[5, 10, 20, 50, 100]"
          [showPageLinks]="true"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="{first} - {last} of {totalRecords}"
          (onPageChange)="onPageChange($event)"
        ></p-paginator>
      </div>
    </div>
  </div>
</ng-container>
