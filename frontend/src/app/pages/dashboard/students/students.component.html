<p-confirmDialog #cd [dismissableMask]="true" [style]="{width: '450px'}">
  <ng-template pTemplate="headless" let-message>
    <div class="flex flex-column align-items-center p-5 surface-overlay border-round-xl">
      <div class="border-circle bg-red-100 inline-flex justify-content-center align-items-center h-6rem w-6rem -mt-4">
        <i class="pi pi-exclamation-triangle text-5xl text-red-500"></i>
      </div>
      <span class="font-bold text-2xl block mb-2 mt-4 text-900">
        {{ message.header }}
      </span>
      <p class="mb-0 text-600 text-center line-height-3">{{ message.message }}</p>
      <div class="flex align-items-center gap-3 mt-5">
        <p-button 
          [label]="'common.cancel' | translate" 
          icon="pi pi-times"
          severity="secondary" 
          size="large"
          [style]="{'min-width': '120px'}"
          (click)="cd.reject()" />
        <p-button 
          [label]="'common.delete' | translate" 
          icon="pi pi-trash"
          severity="danger" 
          size="large"
          [style]="{'min-width': '120px'}"
          (click)="cd.accept()" />
      </div>
    </div>
  </ng-template>
</p-confirmDialog>

<ng-container *ngIf="students$ | async as students">
  <div class="flex flex-column gap-4 px-4">
    <!-- Show empty state if no students and viewing students table -->
    <ng-container *ngIf="!isLoading && totalRecords === 0 && (tableView$ | async) === 'students'; else tableContainer">
      <div class="flex flex-column align-items-center justify-content-center py-8">
        <div class="text-center mb-4">
          <i class="pi pi-users text-6xl text-300 mb-3"></i>
          <h2 class="text-2xl font-bold text-700 mb-2">{{ 'students.empty.title' | translate }}</h2>
          <p class="text-600 mb-4">{{ 'students.empty.message' | translate }}</p>
        </div>
        <p-button 
          [label]="'students.empty.add_student' | translate" 
          icon="pi pi-plus" 
          (onClick)="navigateToCreate()"
          styleClass="p-button-lg">
        </p-button>
      </div>
    </ng-container>

    <!-- Show table (students or contacts) -->
    <ng-template #tableContainer>
      <div class="flex justify-content-end mb-3 mt-3">
        <p-button 
          [icon]="(tableView$ | async) === 'students' ? 'pi pi-users' : 'pi pi-user'"
          [label]="(tableView$ | async) === 'students' ? ('students.table.view_linked_contacts' | translate) : ('students.table.view_students' | translate)"
          styleClass="p-button-text" 
          (onClick)="toggleTableView()"> 
        </p-button>
        <p-button 
          *ngIf="(tableView$ | async) === 'students'"
          icon="pi pi-plus" 
          styleClass="p-button-text border-circle ml-2" 
          (onClick)="navigateToCreate()"> 
        </p-button>
        <p-button icon="pi pi-download" styleClass="p-button-text border-circle ml-2" (onClick)="downloadExcel()"> </p-button>
        <p-button
          [icon]="(viewMode$ | async) === 'list' ? 'pi pi-th-large' : 'pi pi-list'"
          styleClass="p-button-text border-circle ml-2"
          (onClick)="toggleViewMode()"
        >
        </p-button>
      </div>
      <div class="card position-relative">
        <!-- Students Table -->
        <ng-container *ngIf="(tableView$ | async) === 'students'">
          <!-- Add spinner with overlay when loading -->
          <app-spinner *ngIf="isLoading" [overlay]="true"></app-spinner>

          <app-primary-table
            [data]="students"
            [columns]="tableColumns"
            [rows]="10"
            [totalRecords]="totalRecords"
            [viewMode]="(viewMode$ | async) || 'list'"
            (pageChange)="onPageChange($event)"
            (rowsPerPageChange)="onRowsPerPageChange($event)"
            (rowSelect)="onStudentSelect($event)"
            (editRow)="onEditStudent($event)"
            (viewRow)="onStudentSelect($event)"
            (deleteRow)="onDeleteStudent($event)"
            [dataKey]="'id'"
          >
          </app-primary-table>
        </ng-container>

        <!-- Linked Contacts Table -->
        <ng-container *ngIf="(tableView$ | async) === 'contacts'">
          <app-spinner *ngIf="linkedContactsLoading" [overlay]="true"></app-spinner>
          
          <app-primary-table
            *ngIf="!linkedContactsLoading && linkedContactsData.length > 0"
            [data]="linkedContactsData"
            [columns]="linkedContactsColumns"
            [rows]="10"
            [totalRecords]="linkedContactsData.length"
            [viewMode]="(viewMode$ | async) || 'list'"
            [showActions]="false"
            [dataKey]="'id'">
          </app-primary-table>
          
          <div *ngIf="!linkedContactsLoading && linkedContactsData.length === 0" class="flex flex-column align-items-center justify-content-center py-8">
            <i class="pi pi-users text-6xl text-300 mb-3"></i>
            <h3 class="text-xl font-bold text-700 mb-2">{{ 'students.linked_contacts.no_contacts' | translate }}</h3>
            <p class="text-600">{{ 'students.linked_contacts.no_contacts_message' | translate }}</p>
          </div>
        </ng-container>
      </div>
    </ng-template>
  </div>
</ng-container>
