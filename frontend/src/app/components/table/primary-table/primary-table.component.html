<!-- primary-table.component.html -->
<div *ngIf="viewMode === 'list'" class="table-container" #tableContainer>
  <p-table
    [value]="sortedData"
    [loading]="loading"
    [paginator]="false"
    [rows]="rows"
    [totalRecords]="totalRecords"
    [first]="first"
    [globalFilterFields]="globalFilterFields"
    (onRowSelect)="onRowSelect($event)"
    (onRowUnselect)="onRowUnselect($event)"
    (onSort)="onSortChange($event)"
    [selectionMode]="showActions && selectionEnabled ? 'single' : null"
    [scrollable]="true"
    [scrollHeight]="getScrollHeight()"
    [virtualScroll]="useVirtualScroll"
    [virtualScrollItemSize]="16"
    [lazy]="true"
    [resizableColumns]="true"
    [reorderableColumns]="true"
    [class]="viewMode === 'list' ? '' : 'grid-view'"
    [dataKey]="dataKey"
    [(selection)]="selection"
    (selectionChange)="onSelectionChange($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th *ngFor="let col of columns" [pSortableColumn]="col.field">
          {{ col.header | translate }}
          <p-sortIcon *ngIf="col.sortable !== false" [field]="col.field"></p-sortIcon>
        </th>
        <th *ngIf="showActions">{{ 'table.actions' | translate }}</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowData>
      <tr [pSelectableRow]="selectionEnabled ? rowData : null">
        <td *ngFor="let col of columns">
          <ng-container [ngSwitch]="col.type">
            <!-- Attendance Dot -->
            <ng-container *ngSwitchCase="'date-attendance'">
              <span
                *ngIf="getAttendanceDot(rowData, col) === 'present'"
                style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #17998c;"
                title="Present"
              ></span>
              <span
                *ngIf="getAttendanceDot(rowData, col) === 'absent'"
                style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #e74c3c;"
                title="Absent"
              ></span>
              <span
                *ngIf="getAttendanceDot(rowData, col) === null"
                style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #bdc3c7; border: 1px solid #95a5a6;"
                title="No session"
              ></span>
            </ng-container>
            <!-- Button -->
            <ng-container *ngSwitchCase="'button'">
              <p-button
                [label]="col.buttonConfig?.label"
                [icon]="getButtonIcon(col, rowData)"
                [class]="getButtonClass(col, rowData)"
                (onClick)="onButtonClick(col, rowData); $event.stopPropagation()"
                pTooltip
                [tooltipPosition]="'top'"
                [showDelay]="col.buttonConfig?.popover?.showDelay || 150"
                [hideDelay]="col.buttonConfig?.popover?.hideDelay || 150"
                [pTooltip]="getButtonTooltip(col, rowData)"
              ></p-button>
            </ng-container>
            <!-- Toggle -->
            <ng-container *ngSwitchCase="'toggle'">
              <p-inputSwitch
                [ngModel]="rowData[col.field]"
                (onChange)="onToggleChange(col, rowData, $event.checked)"
                (click)="$event.stopPropagation()"
                [disabled]="isToggleDisabled(col, rowData)"
              ></p-inputSwitch>
            </ng-container>
            <!-- Time -->
            <ng-container *ngSwitchCase="'time'">
              <span [style.color]="col.getTextColor ? col.getTextColor(rowData) : 'inherit'">
                {{ col.getValue ? col.getValue(rowData) : rowData[col.field] }}
              </span>
            </ng-container>
            <!-- Duration -->
            <ng-container *ngSwitchCase="'duration'">
              <span [style.color]="col.getTextColor ? col.getTextColor(rowData) : 'inherit'">
                {{ col.getValue ? col.getValue(rowData) : rowData[col.field] }}
              </span>
            </ng-container>
            <!-- Absence Count -->
            <ng-container *ngSwitchCase="'absence-count'">
              <span 
                class="absence-count"
                [class.has-absences]="(col.getValue ? col.getValue(rowData) : rowData[col.field]) > 0"
                [style.color]="(col.getValue ? col.getValue(rowData) : rowData[col.field]) > 0 ? '#e74c3c' : '#27ae60'">
                {{ col.getValue ? col.getValue(rowData) : rowData[col.field] }}
              </span>
            </ng-container>
            <!-- Date -->
            <ng-container *ngSwitchCase="'date'">
              <span [style.color]="col.getTextColor ? col.getTextColor(rowData) : 'inherit'">
                {{ col.getValue ? col.getValue(rowData) : rowData[col.field] }}
              </span>
            </ng-container>
            <!-- Default -->
            <ng-container *ngSwitchDefault>
              <ng-container *ngIf="col.iconConfig">
                <i [class]="col.iconConfig.icon" [style.color]="col.iconConfig.getColor(rowData)" class="pr-2"></i>
              </ng-container>
              <span [style.color]="col.getTextColor ? col.getTextColor(rowData) : 'inherit'">
                {{ col.getValue ? col.getValue(rowData) : rowData[col.field] }}
              </span>
            </ng-container>
          </ng-container>
        </td>
        <td *ngIf="showActions">
          <div class="flex gap-2">
            <p-button
              icon="pi pi-pencil"
              styleClass="p-button-rounded p-button-text"
              (onClick)="onEditClick(rowData); $event.stopPropagation()"
            ></p-button>
            <p-button
              *ngIf="!isArchived(rowData)"
              icon="pi pi-trash"
              styleClass="p-button-rounded p-button-text p-button-danger"
              (onClick)="onDeleteClick(rowData); $event.stopPropagation()"
            ></p-button>
            <p-button
              *ngIf="isArchived(rowData)"
              icon="pi pi-replay"
              styleClass="p-button-rounded p-button-text p-button-success"
              (onClick)="onRestoreClick(rowData); $event.stopPropagation()"
            ></p-button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
  
  <!-- Custom Pagination -->
  <p-paginator
    #paginatorElement
    [rows]="rows"
    [totalRecords]="totalRecords"
    [first]="first"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="{{ 'pagination.current_page_report_template' | translate }}"
    [rowsPerPageOptions]="[10, 25, 50]"
    (onPageChange)="onPageChange($event)"
    (onRowsPerPageChange)="onRowsPerPageChange($event)"
    class="custom-paginator">
  </p-paginator>
</div>

<!-- Grid View -->
<div *ngIf="viewMode === 'grid'" class="grid-container">
  <div class="grid">
    <div *ngFor="let item of data" class="grid-item" (click)="onRowSelect({data: item})">
      <div class="grid-item-content">
        <!-- Profile Image Section -->
        <div *ngIf="showProfileImage" class="profile-section">
          <div class="profile-image-container">
            <img 
              [src]="getProfileImageSrc(item)" 
              [alt]="getDisplayName(item)"
              class="profile-image"
              (error)="onImageError($event)"
            />
          </div>
        </div>

        <!-- Status Badge (only for non-class items) -->
        <div *ngIf="!isClass(item)" class="status-section">
          <div class="status-badge" 
               [class.active]="item.is_active || item.studentStatus" 
               [class.inactive]="!(item.is_active || item.studentStatus)">
            <div class="status-dot"></div>
            <span class="status-text">
              {{ (item.is_active || item.studentStatus) ? ('table.active' | translate) : ('table.inactive' | translate) }}
            </span>
          </div>
        </div>

        <!-- Key Information -->
        <div class="info-section">
          <!-- Class-specific information -->
          <ng-container *ngIf="isClass(item)">
            <!-- Class Code (First Field) -->
            <div *ngIf="item.code" class="info-item">
              <i class="pi pi-id-card info-icon"></i>
              <span class="info-label">{{ 'classes.table.code' | translate }}:</span>
              <span class="info-value">{{ item.code }}</span>
            </div>

            <!-- Class Name -->
            <div class="info-item">
              <i class="pi pi-book info-icon"></i>
              <span class="info-label">{{ 'classes.table.name' | translate }}:</span>
              <span class="info-value">{{ item.model || item.name || 'N/A' }}</span>
            </div>

            <!-- Status -->
            <div class="info-item">
              <i class="pi pi-info-circle info-icon"></i>
              <span class="info-label">{{ 'classes.table.status' | translate }}:</span>
              <span class="info-value">{{ item.archived ? ('classes.table.archived' | translate) : ('classes.table.current' | translate) }}</span>
            </div>

            <!-- Level -->
            <div *ngIf="item.level" class="info-item">
              <i class="pi pi-graduation-cap info-icon"></i>
              <span class="info-label">{{ 'classes.table.level' | translate }}:</span>
              <span class="info-value">{{ item.level }}</span>
            </div>

            <!-- Subject -->
            <div *ngIf="item.subject" class="info-item">
              <i class="pi pi-bookmark info-icon"></i>
              <span class="info-label">{{ 'classes.table.subject' | translate }}:</span>
              <span class="info-value">{{ item.subject }}</span>
            </div>

            <!-- Teacher -->
            <div *ngIf="item.driver" class="info-item">
              <i class="pi pi-user info-icon"></i>
              <span class="info-label">{{ 'classes.table.teacher' | translate }}:</span>
              <span class="info-value">{{ item.driver }}</span>
            </div>

            <!-- Students -->
            <div *ngIf="item.students" class="info-item">
              <i class="pi pi-users info-icon"></i>
              <span class="info-label">{{ 'classes.table.students' | translate }}:</span>
              <span class="info-value">{{ item.students }}</span>
            </div>

            <!-- Sessions Per Week -->
            <div *ngIf="item.sessionsPerWeek" class="info-item">
              <i class="pi pi-calendar info-icon"></i>
              <span class="info-label">{{ 'classes.table.sessions_per_week' | translate }}:</span>
              <span class="info-value">{{ item.sessionsPerWeek }}</span>
            </div>

            <!-- Total Duration -->
            <div *ngIf="item.totalDuration" class="info-item">
              <i class="pi pi-clock info-icon"></i>
              <span class="info-label">{{ 'classes.table.total_duration' | translate }}:</span>
              <span class="info-value">{{ item.totalDuration }}</span>
            </div>

            <!-- Days -->
            <div *ngIf="item.days" class="info-item">
              <i class="pi pi-calendar-times info-icon"></i>
              <span class="info-label">{{ 'classes.table.days' | translate }}:</span>
              <span class="info-value">{{ item.days }}</span>
            </div>
          </ng-container>

          <!-- Staff/Student/Contact information -->
          <ng-container *ngIf="!isClass(item)">
            <div class="info-item">
              <i class="pi pi-user info-icon"></i>
              <span class="info-label">{{ 'staff.table.name' | translate }}:</span>
              <span class="info-value">{{ getDisplayName(item) }}</span>
            </div>
          </ng-container>

          <!-- Linked Contact Type (for linked contacts) -->
          <div *ngIf="item.contactType" class="info-item">
            <i class="pi pi-tag info-icon"></i>
            <span class="info-label">{{ 'students.linked_contacts.contact_type' | translate }}:</span>
            <span class="info-value">{{ getContactTypeValue(item) }}</span>
          </div>

          <!-- Student Name (for linked contacts) -->
          <div *ngIf="item.studentName" class="info-item">
            <i class="pi pi-user-edit info-icon"></i>
            <span class="info-label">{{ 'students.linked_contacts.student_name' | translate }}:</span>
            <span class="info-value">{{ item.studentName }}</span>
          </div>

          <!-- Student Level (for linked contacts) -->
          <div *ngIf="item.studentLevel" class="info-item">
            <i class="pi pi-graduation-cap info-icon"></i>
            <span class="info-label">{{ 'students.linked_contacts.student_level' | translate }}:</span>
            <span class="info-value">{{ item.studentLevel }}</span>
          </div>

          <!-- Student Class (for linked contacts) -->
          <div *ngIf="item.studentClass" class="info-item">
            <i class="pi pi-users info-icon"></i>
            <span class="info-label">{{ 'students.linked_contacts.student_class' | translate }}:</span>
            <span class="info-value">{{ item.studentClass }}</span>
          </div>

          <!-- Role (for staff) -->
          <div *ngIf="getRoleValue(item) && !item.contactType" class="info-item">
            <i class="pi pi-briefcase info-icon"></i>
            <span class="info-label">{{ 'staff.table.role' | translate }}:</span>
            <span class="info-value">{{ getRoleValue(item) }}</span>
          </div>

          <!-- Code (for staff/students) -->
          <div *ngIf="item.code && !item.contactType" class="info-item">
            <i class="pi pi-id-card info-icon"></i>
            <span class="info-label">{{ 'staff.table.code' | translate }}:</span>
            <span class="info-value">{{ item.code }}</span>
          </div>
          
          <!-- Phone -->
          <div *ngIf="item.phone" class="info-item">
            <i class="pi pi-phone info-icon"></i>
            <span class="info-label">{{ item.contactType ? ('students.linked_contacts.phone' | translate) : ('staff.table.phone' | translate) }}:</span>
            <span class="info-value">{{ item.phone }}</span>
          </div>
          
          <!-- Email -->
          <div *ngIf="item.email" class="info-item">
            <i class="pi pi-envelope info-icon"></i>
            <span class="info-label">{{ item.contactType ? ('students.linked_contacts.email' | translate) : ('staff.table.email' | translate) }}:</span>
            <span class="info-value">{{ item.email }}</span>
          </div>

          <!-- Address (for linked contacts) -->
          <div *ngIf="item.address" class="info-item">
            <i class="pi pi-map-marker info-icon"></i>
            <span class="info-label">{{ 'students.linked_contacts.address' | translate }}:</span>
            <span class="info-value">{{ item.address }}</span>
          </div>

          <!-- Branch (for linked contacts) -->
          <div *ngIf="item.branch && !isClass(item)" class="info-item">
            <i class="pi pi-building info-icon"></i>
            <span class="info-label">{{ 'students.linked_contacts.branch' | translate }}:</span>
            <span class="info-value">{{ item.branch }}</span>
          </div>

          <!-- Class (for staff/students) -->
          <div *ngIf="getClassValue(item) && !item.contactType && !isClass(item)" class="info-item">
            <i class="pi pi-users info-icon"></i>
            <span class="info-label">{{ 'staff.table.class' | translate }}:</span>
            <span class="info-value">{{ getClassValue(item) }}</span>
          </div>

          <!-- Branches (for staff/students) -->
          <div *ngIf="getBranchesValue(item) && !item.contactType && !isClass(item)" class="info-item">
            <i class="pi pi-building info-icon"></i>
            <span class="info-label">{{ 'branches' | translate }}:</span>
            <span class="info-value">{{ getBranchesValue(item) }}</span>
          </div>

          <!-- Permissions (for staff only) - Minimal display -->
          <div *ngIf="getPermissionsCount(item) > 0 && !item.contactType && !isClass(item)" class="permissions-section">
            <div class="permissions-chips">
              <span class="permission-chip" *ngFor="let permission of getTopPermissions(item)">
                {{ permission }}
              </span>
              <span class="permission-chip more-permissions" *ngIf="getPermissionsCount(item) > 3">
                +{{ getPermissionsCount(item) - 3 }}
              </span>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div *ngIf="showActions" class="grid-item-actions">
          <p-button 
            icon="pi pi-eye" 
            styleClass="p-button-text p-button-sm" 
            (onClick)="onViewClick(item); $event.stopPropagation()">
          </p-button>
          <p-button 
            icon="pi pi-pencil" 
            styleClass="p-button-text p-button-sm" 
            (onClick)="onEditClick(item); $event.stopPropagation()">
          </p-button>
          <p-button
            *ngIf="!isArchived(item)"
            icon="pi pi-trash"
            styleClass="p-button-text p-button-danger p-button-sm"
            (onClick)="onDeleteClick(item); $event.stopPropagation()">
          </p-button>
          <p-button
            *ngIf="isArchived(item)"
            icon="pi pi-replay"
            styleClass="p-button-text p-button-success p-button-sm"
            (onClick)="onRestoreClick(item); $event.stopPropagation()">
          </p-button>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #defaultTemplate let-item="item" let-col="col">
  {{ item[col.field] }}
</ng-template>
