<div class="p-4 m-auto">
  <!-- Loading spinner -->
  <app-spinner *ngIf="isLoading" [overlay]="true"></app-spinner>

  <!-- Session not found -->
  <div *ngIf="!isLoading && !session" class="mt-4">
    <p-card>
      <div class="text-center">
        <i class="pi pi-exclamation-triangle text-4xl text-orange-400"></i>
        <h3>Session Not Found</h3>
        <p>The session you're looking for doesn't exist or has been removed.</p>
        <p-button 
          label="Back to Sessions" 
          icon="pi pi-arrow-left" 
          (onClick)="navigateBack()">
        </p-button>
      </div>
    </p-card>
  </div>

  <!-- Session details -->
  <div *ngIf="!isLoading && session" class="flex flex-column gap-4">
    <!-- Header -->
    <div>
      <div class="flex justify-content-between align-items-start mb-3">
        <div class="flex gap-4">
          <h1 class="text-3xl font-semibold m-0 mb-2 flex align-items-center">
            <app-color-dot class="mr-2" [color]="session.taxi.color" size="1rem"></app-color-dot>
            {{ session.taxi.name || 'Session Details' }}
          </h1>
          <!-- <app-outline-button *ngIf="session.mode !== 'in_person'"
              [borderColor]="'var(--primary-color)'"
              [textColor]="'var(--primary-color)'"
              [hoverBackgroundColor]="'var(--primary-color)'"
              [hoverTextColor]="'white'"
              [disabled]="getSessionStatus() !== 'In Progress'"
              (onClick)="launchSessionOnline()">
              {{'sessions.launch.title' | translate}}
          </app-outline-button> -->
          <app-outline-button
              [borderColor]="'var(--primary-color)'"
              [textColor]="'var(--primary-color)'"
              [hoverBackgroundColor]="'var(--primary-color)'"
              [hoverTextColor]="'white'"              
              (click)="launchSessionOnline()">
              {{'sessions.launch.title' | translate}}
          </app-outline-button>
        </div>
        <div class="flex gap-2">
          <app-outline-button 
            [borderColor]="'var(--primary-color)'" 
            [fullWidth]="true" 
            (click)="editSession()">
              {{ 'common.edit' | translate }}
          </app-outline-button>
          <app-outline-button 
            [borderColor]="'red'"
            [textColor]="'red'"
            [hoverBackgroundColor]="'red'"
            [hoverTextColor]="'white'"
            [disabled]="isDeleting"
            (click)="openDeleteDialog()">
            Delete
          </app-outline-button>
        </div>
      </div>
    </div>

    <!-- Session Info -->
    <div class="custom-card p-3">
      <div class="flex gap-4 align-items-start">
        <!-- Column 1: Class, Branch, Subject, Level, CEFR -->
        <div class="flex-1 flex flex-column gap-2">
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">Class:</label>
            <span>{{ session.taxi.name || 'N/A' }}</span>
          </div>
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">Branch:</label>
            <span>{{ session.taxi.branch || 'N/A' }}</span>
          </div>
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">Subject:</label>
            <span>{{ session.taxi.subject || 'N/A' }}</span>
          </div>
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">Level:</label>
            <span>{{ session.taxi.level || 'N/A' }}</span>
          </div>
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">CEFR:</label>
            <span>N/A</span>
          </div>
        </div>

        <!-- Column 2: Teacher, Mode, Room -->
        <div class="flex-1 flex flex-column gap-2">
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">Teacher:</label>
            <span>{{ (session.teachers?.length || 0) > 0 ? ((session.teachers?.length || 0) + ' teacher' + ((session.teachers?.length || 0) > 1 ? 's' : '')) : 'N/A' }}</span>
          </div>
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">Mode:</label>
            <span>{{ formatMode(session.mode) }}</span>
          </div>
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">Room:</label>
            <span>{{ session.classroom?.name || 'N/A' }}</span>
          </div>
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">Invitation:</label>
            <span>{{ session.invite_participants ? 'Sent to all participants via e-mail.' : 'N/A' }}</span>
          </div>
        </div>

        <!-- Column 3: Date, Actual Time -->
        <div class="flex-1 flex flex-column gap-2">
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">Date:</label>
            <span>{{ formatDate(session.start_date) }}</span>
          </div>
          <div class="flex align-items-center gap-2">
            <label class="font-semibold text-primary">Actual Time:</label>
            <span>{{ formatTimeRange(session.start_date, session.end_date) }}</span>
          </div>
        </div>

        <!-- Column 4: Materials -->
        <div class="flex-1 flex flex-column gap-2">
          <h4 class="m-0 mb-2">Material:</h4>
          <div class="flex flex-column gap-2">
            <div class="flex align-items-center gap-2 p-2 surface-100 border-round" *ngFor="let material of materials">
              <i class="pi pi-book text-primary"></i>
              <span class="text-sm">{{ material.name || 'N/A' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Students and Media Section -->
    <div class="grid">
      <!-- Students Card -->
      <div class="col-12 lg:col-6">
        <div class="custom-card p-3 h-full flex flex-column">
          <div class="mb-3">
            <h2 class="text-2xl font-bold m-0 mb-4 text-primary">Students: </h2>
          </div>
          
          <!-- Loading state for students -->
          <div *ngIf="isLoadingStudents" class="text-center p-4 flex-1 flex align-items-center justify-content-center">
            <div>
              <i class="pi pi-spin pi-spinner text-2xl"></i>
              <p class="mt-2">Loading students...</p>
            </div>
          </div>
          
          <!-- Students table -->
          <div *ngIf="!isLoadingStudents" class="flex-1 flex flex-column">
            <div class="students-scrollable" *ngIf="students.length > 0">
              <p-table [value]="students" styleClass="p-datatable-sm">
              <ng-template pTemplate="header">
                <tr>
                  <th style="width: 60%;">Student Name</th>
                  <th style="width: 20%; text-align: center;">Present</th>
                  <th style="width: 20%; text-align: center;">Absent</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-student>
                <tr>
                  <td>
                    <div class="flex align-items-center gap-2">
                      <i class="pi pi-user text-gray-500"></i>
                      <span>{{ student.firstname }} {{ student.lastname }}</span>
                    </div>
                  </td>
                  <td class="text-center">
                    <div class="flex justify-content-center align-items-center">
                      <i 
                        class="pi text-lg cursor-pointer transition-colors duration-200"
                        [class.pi-check-circle]="student.present"
                        [class.pi-circle]="!student.present"
                        [class.pi-spin]="isUpdatingAttendance(student.id)"
                        [class.text-green-500]="student.present"
                        [class.text-gray-300]="!student.present"
                        [class.hover:text-green-600]="!student.present"
                        [class.opacity-50]="isUpdatingAttendance(student.id)"
                        [title]="'Click to mark present'"
                        (click)="toggleAttendance(student, true)"
                        [style.pointer-events]="isUpdatingAttendance(student.id) ? 'none' : 'auto'">
                      </i>
                    </div>
                  </td>
                  <td class="text-center">
                    <div class="flex justify-content-center align-items-center">
                      <i 
                        class="pi text-lg cursor-pointer transition-colors duration-200"
                        [class.pi-times-circle]="student.absent"
                        [class.pi-circle]="!student.absent"
                        [class.pi-spin]="isUpdatingAttendance(student.id)"
                        [class.text-red-500]="student.absent"
                        [class.text-gray-300]="!student.absent"
                        [class.hover:text-red-600]="!student.absent"
                        [class.opacity-50]="isUpdatingAttendance(student.id)"
                        [title]="'Click to mark absent'"
                        (click)="toggleAttendance(student, false)"
                        [style.pointer-events]="isUpdatingAttendance(student.id) ? 'none' : 'auto'">
                      </i>
                    </div>
                  </td>
                </tr>
              </ng-template>
              <ng-template pTemplate="footer">
                <tr class="font-semibold">
                  <td>
                    <div class="flex align-items-center gap-2">
                      <i class="pi pi-users text-gray-500"></i>
                      <span>Total Students: {{ students.length }}</span>
                    </div>
                  </td>
                  <td class="text-center">
                    <div class="flex justify-content-center align-items-center gap-1">
                      <i class="pi pi-check-circle text-green-500"></i>
                      <span class="text-green-600">{{ getTotalPresent() }}</span>
                    </div>
                  </td>
                  <td class="text-center">
                    <div class="flex justify-content-center align-items-center gap-1">
                      <i class="pi pi-times-circle text-red-500"></i>
                      <span class="text-red-600">{{ getTotalAbsent() }}</span>
                    </div>
                  </td>
                </tr>
              </ng-template>
              </p-table>
            </div>
            
            <!-- No students message -->
            <div *ngIf="students.length === 0" class="flex-1 flex align-items-center justify-content-center text-center p-4 text-gray-500">
              <div>
                <i class="pi pi-users text-3xl mb-2"></i>
                <p>No students enrolled in this session.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Watch Session Card -->
      <div class="col-12 lg:col-6">
        <div class="custom-card p-3 h-full flex flex-column">
          <div class="video-container flex-1 flex flex-column">
            <!-- Video placeholder -->
            <div class="relative w-full flex-1 bg-gray-900 border-round flex align-items-center justify-content-center mb-3">
              <div class="w-4rem h-4rem bg-white-alpha-90 border-round-full flex align-items-center justify-content-center cursor-pointer transition-all transition-duration-300 hover:bg-white hover:scale-105">
                <i class="pi pi-play text-2xl text-gray-900 ml-1"></i>
              </div>
            </div>
            
            <!-- Video controls -->
            <div class="flex align-items-center gap-3">
              <div class="flex gap-2">
                <i class="pi pi-step-backward text-gray-500 cursor-pointer p-1 hover:text-primary"></i>
                <i class="pi pi-play text-gray-500 cursor-pointer p-1 hover:text-primary"></i>
                <i class="pi pi-step-forward text-gray-500 cursor-pointer p-1 hover:text-primary"></i>
              </div>
              
              <div class="flex-1 h-1rem bg-gray-300 border-round relative">
                <div class="w-3 h-full bg-red-500 border-round"></div>
              </div>
              
              <div class="flex gap-2">
                <i class="pi pi-volume-up text-gray-500 cursor-pointer p-1 hover:text-primary"></i>
                <i class="pi pi-cog text-gray-500 cursor-pointer p-1 hover:text-primary"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Chat And Download Files -->
    <div class="grid">
      <div class="col-12 md:col-6">
        <div class="custom-card p-3 cursor-pointer" (click)="openChat()">
          <div class="flex align-items-center gap-3">
            <i class="pi pi-comments text-3xl text-blue-500"></i>
            <div>
              <h3 class="m-0 mb-2 text-xl font-semibold">Read the chat:</h3>
              
              <span class="underline text-sm text-gray-600">Click to open this session's chat in your messages.</span>
            </div>
          </div>
        </div>
      </div>
      <app-messaging-container></app-messaging-container>
      <div class="col-12 md:col-6">
        <div class="custom-card p-3 cursor-pointer" (click)="downloadFiles()">
          <div class="flex align-items-center gap-3">
            <i class="pi pi-folder text-3xl text-orange-500"></i>
            <div>
              <h3 class="m-0 mb-2 text-xl font-semibold">Download the files:</h3>
              <span class="underline text-sm text-gray-600">Click to view this session's files in your resources.</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes Card -->
    <div class="custom-card p-3">
      <div class="mb-3">
        <h2 class="text-2xl font-bold m-0 mb-4 text-primary">Notes: </h2>
      </div>
      <div>
        <p class="m-0">{{ session.notes || 'No notes available for this session.' }}</p>
      </div>
    </div>

    <!-- Confirm Delete Dialog -->
    <app-confirm-dialog 
      #confirmDlg
      (onConfirmAction)="onConfirmDelete($event)"
      [customHeaderText]="'Delete Session'"
      [customMessageText]="'Are you sure you want to delete this session?'">
    </app-confirm-dialog>

    <!-- Absence Type Selection Dialog -->
    <app-confirm-dialog 
      #absenceConfirmDlg
      (onAbsenceTypeConfirm)="onAbsenceTypeConfirm($event)"
      (onConfirmAction)="onAbsenceTypeCancel($event)"
      [showAbsenceTypeSelection]="true"
      [absenceTypes]="absenceTypes"
      [selectedAbsenceType]="selectedAbsenceType"
      [studentName]="selectedStudent ? selectedStudent.firstname + ' ' + selectedStudent.lastname : ''">
    </app-confirm-dialog>
  </div>
</div>
