<div class="session-form-container">
  <div class="flex justify-content-between align-items-center mb-2 mt-4">
    <h3 class="text-primary font-bold text-xl m-0">Sessions</h3>
    <button pButton type="button" icon="pi pi-plus"
            class="p-button-rounded p-button-outlined"
            (click)="addSession()">
    </button>
  </div>

  <!-- Sessions Form -->
  <form [formGroup]="sessionsForm">
    <div formArrayName="sessions">
      <ng-container *ngFor="let sessionForm of sessions.controls; let i = index">
        <div [formGroupName]="i" class="mt-4 mb-4 relative">

          <!-- Remove Session Button -->
          <button type="button"
            class="p-button p-button-rounded p-button-text p-button-danger absolute"
            style="right: 0; top: -15px; z-index: 1;"
            title="Remove this session"
            (click)="removeSession(i)">
            <i class="pi pi-trash"></i>
          </button>

          <!-- Session Form Grid -->
          <div class="grid align-items-center">
            <!-- Day -->
            <div class="col-12 md:col-2">
              <span class="font-medium">Day</span>
              <app-primary-dropdown
                formControlName="day"
                [options]="sessionService.DAYS"
                placeholder="Day"
                class="w-full mt-1">
              </app-primary-dropdown>
            </div>

            <!-- Start Time -->
            <div class="col-12 md:col-2">
              <span class="font-medium">Start Time</span>
              <app-primary-dropdown
                formControlName="startTime"
                [options]="sessionService.START_TIMES"
                placeholder="Start Time"
                class="w-full mt-1">
              </app-primary-dropdown>
            </div>

            <!-- Duration -->
            <div class="col-12 md:col-2">
              <span class="font-medium">Duration</span>
              <app-primary-dropdown
                formControlName="duration"
                [options]="sessionService.DURATIONS"
                placeholder="Duration"
                class="w-full mt-1">
              </app-primary-dropdown>
            </div>

            <!-- Date Range -->
            <div class="col-12 md:col-3">
              <span class="font-medium">Start Date - End Date</span>
              <p-calendar formControlName="dateRange"
                styleClass="w-full mt-1"
                placeholder="Start Date - End Date"
                selectionMode="range"
                [showIcon]="true"
                dateFormat="dd/mm/yy">
              </p-calendar>
            </div>

            <!-- Frequency -->
            <div class="col-12 md:col-3">
              <span class="font-medium">Frequency</span>
              <div class="flex align-items-center gap-2 mt-1">
                <span class="mr-2">Every</span>
                <p-inputNumber formControlName="frequencyValue"
                  [showButtons]="true"
                  [buttonLayout]="'stacked'"
                  [incrementButtonIcon]="'pi pi-chevron-up'"
                  [decrementButtonIcon]="'pi pi-chevron-down'"
                  [min]="1" [max]="52"
                  styleClass="frequency-input-optimized w-5rem">
                </p-inputNumber>
                <span>weeks</span>
              </div>
            </div>
          </div>

          <!-- Mode and Classroom Row -->
          <div class="grid mt-2">
            <!-- Mode -->
            <div class="col-12 md:col-3">
              <span class="font-medium">Mode <span class="text-red-500">*</span></span>
              <app-primary-dropdown
                formControlName="mode"
                [options]="sessionService.MODES"
                placeholder="Mode"
                class="w-full mt-1">
              </app-primary-dropdown>
            </div>

            <!-- Classroom (shown only when mode is hybrid or in_person, always optional) -->
            <div class="col-12 md:col-4" *ngIf="isClassroomVisible(i)">
              <span class="font-medium">Classroom</span>
              <app-primary-dropdown
                formControlName="classroom"
                [options]="classrooms"
                placeholder="Select Classroom"
                class="w-full mt-1">
              </app-primary-dropdown>
            </div>
          </div>

          <!-- Preview Button -->
          <!-- <div class="grid mt-3" *ngIf="canPreviewSession(i)">
            <div class="col-12">
              <button type="button" class="p-button p-button-outlined p-button-sm"
                (click)="previewSession(i)"
                [disabled]="isPreviewingSession">
                <i class="pi pi-eye mr-2"></i>
                <span *ngIf="!isPreviewingSession">Preview Sessions</span>
                <span *ngIf="isPreviewingSession" class="pi pi-spin pi-spinner mr-2"></span>
                <span *ngIf="isPreviewingSession">Generating Preview...</span>
              </button>
            </div>
          </div> -->

          <!-- Session Preview Results -->
          <div class="mt-3" *ngIf="sessionPreviews[i]">
            <div class="p-3 bg-gray-50 border-round-md">
              <div class="flex justify-content-between align-items-center mb-2">
                <h5 class="m-0 text-primary">Session Preview</h5>
                <button type="button" class="p-button p-button-text p-button-sm"
                  (click)="clearPreview(i)">
                  <i class="pi pi-times"></i>
                </button>
              </div>
              <div class="text-sm text-600 mb-2">
                Total sessions: <strong>{{ sessionPreviews[i].totalSessions }}</strong> |
                Showing: <strong>{{ sessionPreviews[i].preview.length }}</strong>
              </div>
              <div class="grid gap-2">
                <div *ngFor="let preview of sessionPreviews[i].preview" class="col-12 md:col-6 lg:col-4">
                  <div class="border-1 border-300 p-2 border-round text-sm">
                    <div class="font-medium">{{ preview.dayOfWeek }}</div>
                    <div class="text-600">{{ preview.date }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Validation Messages -->
          <div class="mt-2" *ngIf="sessionValidationMessages[i]">
            <p-messages [value]="sessionValidationMessages[i]" [closable]="true"></p-messages>
          </div>

          <!-- Divider between sessions -->
          <div *ngIf="i < sessions.length - 1" class="border-1 border-300 w-full my-3"></div>
        </div>
      </ng-container>
    </div>
  </form>

  <!-- Bulk Actions -->
  <!-- <div class="mt-4 flex gap-2 justify-content-end">
    <button type="button" class="p-button p-button-outlined"
      (click)="validateAllSessions()"
      [disabled]="isValidatingBulk">
      <span *ngIf="!isValidatingBulk" class="pi pi-shield mr-2"></span>
      <span *ngIf="isValidatingBulk" class="pi pi-spin pi-spinner mr-2"></span>
      {{ isValidatingBulk ? 'Validating...' : 'Validate All' }}
    </button>
  </div> -->
</div>

