<!-- chat-window.component.html - With Attachment Display -->
<div class="h-full flex flex-column surface-card">
  <!-- Header -->
  <div class="flex align-items-center justify-content-between p-3 border-bottom-1 surface-border bg-white">
    <div class="flex align-items-center gap-3">
      <!-- Avatar with Online Status -->
      <div class="relative">
        <p-avatar 
          [label]="getAvatarInitials()" 
          shape="circle" 
          size="large"
          [style]="{'background-color': getAvatarColor(), 'color': 'white'}">
        </p-avatar>
        
        <div *ngIf="isOnline()" 
             class="absolute border-circle bg-green-500"
             style="width: 12px; height: 12px; top: -2px; right: -2px; border: 2px solid white;">
        </div>
      </div>
      
      <!-- Chat Info -->
      <div class="flex flex-column">
        <div class="flex align-items-center gap-2">
          <span class="font-semibold text-900">{{ getChatName() }}</span>
          <p-tag 
            [value]="getUserRole()"
            [severity]="getRoleSeverity()"
            styleClass="text-xs">
          </p-tag>
        </div>
        <span class="text-sm text-500">{{ getChatSubtitle() }}</span>
      </div>
    </div>
    
    <p-button 
      icon="pi pi-ellipsis-v" 
      [rounded]="true" 
      [text]="true"
      [pTooltip]="'messages.more_options' | translate"
      tooltipPosition="bottom"
      (onClick)="showChatMenu($event, contextMenu)">
    </p-button>
  </div>

  <!-- Messages Container -->
  <p-scrollPanel class="scrollPanel flex-1" [style]="{height: 'calc(100vh - 200px)'}" #scrollPanel>
    <div class="flex flex-column gap-3 p-3">
      <div *ngFor="let msg of messages; trackBy: trackByMessageId"
           class="flex"
           [class.justify-content-end]="isSent(msg)"
           [class.justify-content-start]="!isSent(msg)">
        
        <div class="flex flex-column max-w-30rem message-wrapper"
             [class.align-items-end]="isSent(msg)"
             [class.align-items-start]="!isSent(msg)">
          
          <!-- Sender Name (group chats only) -->
          <div *ngIf="!isSent(msg) && chat.type === 'group'" 
               class="text-xs text-600 mb-1 ml-2">
            {{ getSenderName(msg) }}
          </div>
          
          <!-- Reply Context -->
          <div *ngIf="msg.replyToMessage" 
               class="reply-context mb-2"
               [class.ml-2]="!isSent(msg)"
               [class.mr-2]="isSent(msg)">
            <p-card styleClass="reply-card p-2">
              <div class="flex align-items-start gap-2">
                <i class="pi pi-reply text-xs text-500 mt-1"></i>
                <div class="flex-1 min-w-0">
                  <div class="text-xs font-medium text-600 mb-1">
                    {{ getReplyToSenderName(msg.replyToMessage) }}
                  </div>
                  <div class="text-xs text-500 line-height-3 overflow-hidden text-overflow-ellipsis" 
                       style="max-height: 2.4em;">
                    {{ msg.replyToMessage.content }}
                  </div>
                </div>
              </div>
            </p-card>
          </div>
          
          <!-- Message Bubble -->
          <div class="relative">
            <!-- Message Actions (hover) -->
            <div class="message-actions absolute"
                 [class.message-actions-sent]="isSent(msg)"
                 [class.message-actions-received]="!isSent(msg)">
              
              <p-button
                icon="pi pi-reply"
                [rounded]="true"
                [text]="true"
                size="small"
                class="action-btn"
                [pTooltip]="'messages.reply' | translate"
                tooltipPosition="top"
                (onClick)="startReply(msg)"
                [style]="{'width': '28px', 'height': '28px'}">
              </p-button>
              
              <p-button
                *ngIf="isSent(msg)"
                icon="pi pi-trash"
                [rounded]="true"
                [text]="true"
                size="small"
                class="action-btn"
                [pTooltip]="'messages.delete' | translate"
                tooltipPosition="top"
                (onClick)="deleteMessage(msg)"
                [style]="{'width': '28px', 'height': '28px'}">
              </p-button>
            </div>
            
            <!-- Message Content -->
            <div class="p-3 border-round-2xl shadow-1 max-w-full word-wrap message-bubble"
                 [class.bg-primary]="isSent(msg)"
                 [class.text-white]="isSent(msg)"
                 [class.surface-100]="!isSent(msg)"
                 [class.text-900]="!isSent(msg)"
                 (contextmenu)="showMessageContextMenu($event, msg, messageContextMenu)">
              
              <!-- Text Content -->
              <div *ngIf="msg.content" class="text-sm line-height-3"
                   [class.mb-2]="msg.attachments?.length">
                {{ msg.content }}
              </div>

              <!-- ðŸŽ¯ ATTACHMENTS DISPLAY -->
              <div *ngIf="msg.attachments?.length" class="attachments-container mt-2">
                <div class="attachment-grid">
                  
                  <!-- Image Attachments -->
                  <ng-container *ngFor="let att of msg.attachments">
                    
                    <!-- Image Preview -->
                    <div *ngIf="AttachmentUtils.isImage(att.contentType)" 
                         class="attachment-image-wrapper cursor-pointer"
                         (click)="openAttachment(att)">
                      <img [src]="att.url" 
                           [alt]="att.filename"
                           class="attachment-image"
                           loading="lazy"
                           onerror="this.src='assets/images/image-placeholder.png'" />
                      <div class="attachment-image-overlay">
                        <i class="pi pi-search-plus text-white"></i>
                      </div>
                    </div>

                    <!-- Video Preview -->
                    <div *ngIf="AttachmentUtils.isVideo(att.contentType)" 
                         class="attachment-video-wrapper cursor-pointer"
                         (click)="openAttachment(att)">
                      <video [src]="att.url" 
                             class="attachment-video"
                             preload="metadata"
                             [poster]="att.url + '#t=0.5'">
                      </video>
                      <div class="attachment-video-overlay">
                        <i class="pi pi-play-circle text-white" style="font-size: 3rem;"></i>
                      </div>
                    </div>

                    <!-- File Attachment (Documents, Audio, Archives) -->
                    <div *ngIf="!AttachmentUtils.isImage(att.contentType) && !AttachmentUtils.isVideo(att.contentType)"
                         class="attachment-file-card"
                         [class.sent-file]="isSent(msg)"
                         [class.received-file]="!isSent(msg)">
                      
                      <div class="flex align-items-center gap-2 p-2">
                        <!-- File Icon -->
                        <div class="file-icon-wrapper">
                          <i [class]="AttachmentUtils.getFileIcon(att.contentType) + ' text-2xl'"
                             [class.text-white]="isSent(msg)"
                             [class.text-primary]="!isSent(msg)"></i>
                        </div>

                        <!-- File Info -->
                        <div class="flex-1 min-w-0">
                          <div class="text-sm font-medium overflow-hidden text-overflow-ellipsis white-space-nowrap"
                               [class.text-white]="isSent(msg)"
                               [class.text-900]="!isSent(msg)"
                               [pTooltip]="att.filename"
                               tooltipPosition="top">
                            {{ att.filename }}
                          </div>
                          <div class="text-xs"
                               [class.text-blue-100]="isSent(msg)"
                               [class.text-500]="!isSent(msg)">
                            {{ AttachmentUtils.formatFileSize(att.size) }}
                          </div>
                        </div>

                        <!-- Download Button -->
                        <p-button
                          icon="pi pi-download"
                          [rounded]="true"
                          [text]="true"
                          size="small"
                          [pTooltip]="'Download'"
                          tooltipPosition="top"
                          (onClick)="openAttachment(att)"
                          [style]="{'width': '32px', 'height': '32px'}">
                        </p-button>
                      </div>
                    </div>

                  </ng-container>
                </div>
              </div>
              
              <!-- Message Time and Status -->
              <div class="flex align-items-center justify-content-end gap-1 mt-2"
                   [class.text-white]="isSent(msg)"
                   [class.text-500]="!isSent(msg)">
                <span class="text-xs">{{ msg.timestamp | date:'shortTime' }}</span>
                
                <div *ngIf="isSent(msg)" class="flex align-items-center ml-1">
                  <i *ngIf="getMessageStatus(msg) === 'sent'" 
                     class="pi pi-check text-xs"
                     [class.text-white]="isSent(msg)">
                  </i>
                  
                  <ng-container *ngIf="getMessageStatus(msg) === 'delivered'">
                    <i class="pi pi-check text-xs"
                       [class.text-white]="isSent(msg)">
                    </i>
                    <i class="pi pi-check text-xs -ml-1"
                       [class.text-white]="isSent(msg)">
                    </i>
                  </ng-container>
                  
                  <ng-container *ngIf="getMessageStatus(msg) === 'read'">
                    <i class="pi pi-check text-xs text-blue-400"></i>
                    <i class="pi pi-check text-xs text-blue-400 -ml-1"></i>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div #scrollContainer class="messages-container">
        <!-- Typing Indicator -->
        <div *ngIf="typingFrom && !isSentUser(typingFrom)" 
             class="typing-indicator-container">
          <div class="flex align-items-center gap-2 p-2 surface-100 border-round-2xl">
            <div class="flex gap-1">
              <div class="typing-dot bg-600"></div>
              <div class="typing-dot bg-600"></div>
              <div class="typing-dot bg-600"></div>
            </div>
            <span class="text-xs text-600">{{ getTypingUserName() }} {{ 'messages.is_typing' | translate }}</span>
          </div>
        </div>
        
        <!-- Upload Progress Indicator -->
        <div *ngIf="isUploadingAttachments" 
             class="upload-progress-container">
          <div class="flex align-items-center gap-2 p-3 surface-100 border-round-2xl">
            <i class="pi pi-spin pi-spinner text-primary"></i>
            <div class="flex flex-column">
              <span class="text-sm font-medium text-primary">{{ 'messages.uploading_files' | translate }}</span>
              <span class="text-xs text-500">{{ uploadingFiles.length }} {{ 'messages.files_selected' | translate }}</span>
            </div>
          </div>
        </div>

        <!-- Pending Attachments Preview -->
        <div *ngIf="pendingAttachments.length > 0" class="pending-attachments-preview">
          <p-card styleClass="pending-card">
            <div class="flex flex-column gap-2">
              <div class="flex align-items-center justify-content-between">
                <span class="text-sm font-medium">{{ pendingAttachments.length }} file(s) ready to send</span>
                <p-button
                  icon="pi pi-times"
                  [rounded]="true"
                  [text]="true"
                  size="small"
                  (onClick)="clearPendingAttachments()">
                </p-button>
              </div>
              
              <div class="flex flex-wrap gap-2">
                <p-chip *ngFor="let att of pendingAttachments"
                        [label]="att.filename"
                        [removable]="true"
                        (onRemove)="removePendingAttachment(att)">
                  <i [class]="AttachmentUtils.getFileIcon(att.contentType || '') + ' mr-2'"></i>
                </p-chip>
              </div>
            </div>
          </p-card>
        </div>

        <!-- Spacer to prevent input overlap -->
        <div class="typing-spacer"></div>
      </div>
    </div>
  </p-scrollPanel>

  <!-- Reply Context Bar -->
  <div *ngIf="replyingToMessage" 
       class="reply-bar flex align-items-center justify-content-between p-2 bg-blue-50 border-top-1 border-blue-200">
    <div class="flex align-items-center gap-2">
      <i class="pi pi-reply text-blue-600"></i>
      <div class="flex flex-column">
        <span class="text-xs font-medium text-blue-800">
          {{ 'messages.replying_to' | translate }} {{ getReplyToSenderName(replyingToMessage) }}
        </span>
        <span class="text-xs text-blue-600 overflow-hidden text-overflow-ellipsis" 
              style="max-width: 300px; white-space: nowrap;">
          {{ replyingToMessage.content }}
        </span>
      </div>
      <p-button 
        icon="pi pi-times" 
        [rounded]="true" 
        [text]="true" 
        size="small"
        [pTooltip]="'messages.cancel_reply' | translate"
        (onClick)="cancelReply()">
      </p-button>
    </div>
  </div>

  <!-- Message Input Area -->
  <div class="message-input-container">
    <div class="message-input p-3 border-top-1 surface-border bg-white">
      <div class="flex align-items-end gap-2">
        <!-- Attachment Button -->
        <app-attachment
          [chatId]="chat._id"
          [disabled]="isUploadingAttachments"
          (uploadStart)="onUploadStart($event)"
          (uploadComplete)="onUploadComplete($event)"
          (uploadError)="onUploadError($event)">
        </app-attachment>
        
        <!-- Message Input -->
        <div class="flex-1">
          <textarea 
            class="w-full p-inputtext"
            rows="1"
            [(ngModel)]="newMessage"
            (input)="onMessageInput()" 
            (keydown)="handleKeydown($event)"
            [placeholder]="'messages.type_message' | translate">
          </textarea>
        </div>
        
        <!-- Send Button -->
        <p-button 
          icon="pi pi-send" 
          [rounded]="true"
          [pTooltip]="'messages.send_message' | translate"
          [disabled]="!canSendMessage()"
          (onClick)="sendMessage()">
        </p-button>
      </div>
    </div>
  </div>
</div>

<!-- Context Menus -->
<p-menu #contextMenu [model]="menuItems" [popup]="true"></p-menu>
<p-menu #messageContextMenu [model]="messageMenuItems" [popup]="true"></p-menu>