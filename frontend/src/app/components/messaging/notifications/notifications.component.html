<!-- notifications.component.html - FIXED with type guards -->
<div class="notification-wrapper">
  <!-- Notification Bell Icon with Badge -->
  <i class="pi pi-bell notification-icon" 
     pBadge 
     [value]="badgeValue" 
     severity="danger"
     (click)="toggleNotificationPanel($event)"
     pTooltip="Notifications"
     tooltipPosition="bottom">
  </i>
</div>

<!-- Overlay Panel for Notifications -->
<p-overlayPanel 
  #notificationPanel 
  [style]="{width: '420px', maxHeight: '600px'}"
  [showCloseIcon]="false"
  [dismissable]="true"
  (onShow)="onPanelShow()"
  (onHide)="onPanelHide()">
  
  <!-- Panel Header -->
  <div class="notification-header">
    <h4 class="header-title">Notifications</h4>
    <div class="header-actions">
      <button 
        pButton 
        type="button" 
        icon="pi pi-check-square" 
        class="p-button-text p-button-sm action-btn"
        pTooltip="Mark all as read"
        tooltipPosition="top"
        (click)="markAllAsRead()"
        [disabled]="unreadCount === 0 || loading">
      </button>
      <button 
        pButton 
        type="button" 
        icon="pi pi-trash" 
        class="p-button-text p-button-sm action-btn"
        pTooltip="Clear all"
        tooltipPosition="top"
        (click)="clearAllNotifications()"
        [disabled]="notifications.length === 0 || loading">
      </button>
      <button 
        pButton 
        type="button" 
        icon="pi pi-times" 
        class="p-button-text p-button-sm action-btn"
        pTooltip="Close"
        tooltipPosition="top"
        (click)="notificationPanel.hide()">
      </button>
    </div>
  </div>
  
  <!-- Panel Content -->
  <div class="notification-content">
    <!-- Loading State -->
    <div *ngIf="loading && notifications.length === 0" class="state-container">
      <div class="loading-state">
        <i class="pi pi-spin pi-spinner loading-icon"></i>
        <span>Loading notifications...</span>
      </div>
    </div>
    
    <!-- Error State -->
    <div *ngIf="error && !loading" class="state-container">
      <div class="error-state">
        <i class="pi pi-exclamation-triangle error-icon"></i>
        <p class="error-message">{{ error }}</p>
        <button 
          pButton 
          type="button" 
          label="Try Again" 
          class="p-button-sm p-button-outlined"
          (click)="retryLoading()">
        </button>
      </div>
    </div>
    
    <!-- Empty State -->
    <div *ngIf="!loading && !error && notifications.length === 0" class="state-container">
      <div class="empty-state">
        <i class="pi pi-inbox empty-icon"></i>
        <p>No notifications</p>
        <span class="empty-subtext">You're all caught up!</span>
      </div>
    </div>
    
    <!-- Notifications List -->
    <div *ngIf="notifications.length > 0 && !error" class="notifications-list">
      <div 
        *ngFor="let notification of notifications; trackBy: trackByNotificationId" 
        class="notification-item"
        [class.unread]="!notification.isRead"
        (click)="onNotificationClick(notification)">
        
        <!-- Notification Icon -->
        <div class="notification-icon-container">
          <i [class]="getNotificationIcon(notification.type)"
             [style.color]="getNotificationIconColor(notification.type)">
          </i>
          <div *ngIf="!notification.isRead" class="unread-indicator"></div>
        </div>
        
        <!-- Notification Content -->
        <div class="notification-details">
          <div class="notification-title">{{ notification.title }}</div>
          <div class="notification-content-text">{{ notification.content }}</div>
          
          <!-- ✅ FIXED: Related User Info with type guard -->
          <div *ngIf="isPopulatedUser(notification.relatedUserId)" class="notification-meta">
            <span class="related-user">{{ getRelatedUsername(notification.relatedUserId) }}</span>
          </div>
          
          <!-- ✅ FIXED: Related Chat Info with type guard -->
          <div *ngIf="isPopulatedChat(notification.relatedChatId)" class="notification-meta">
            <span class="related-chat">in {{ getRelatedChatName(notification.relatedChatId) }}</span>
          </div>
          
          <!-- ✅ FIXED: Timestamp with proper conversion -->
          <div class="notification-time">{{ formatTime(notification.createdAt) }}</div>
        </div>
        
        <!-- Notification Actions -->
        <div class="notification-actions">
          <button 
            *ngIf="!notification.isRead"
            pButton 
            type="button" 
            icon="pi pi-check" 
            class="p-button-text p-button-sm action-btn"
            pTooltip="Mark as read"
            tooltipPosition="left"
            (click)="markAsRead(notification._id, $event)">
          </button>
          <button 
            pButton 
            type="button" 
            icon="pi pi-times" 
            class="p-button-text p-button-sm action-btn delete-btn"
            pTooltip="Delete"
            tooltipPosition="left"
            (click)="deleteNotification($event, notification._id)">
          </button>
        </div>
      </div>
    </div>
    
    <!-- Load More -->
    <div *ngIf="hasMore && !loading && !error" class="load-more-container">
      <button 
        pButton 
        type="button" 
        label="Load More" 
        class="p-button-text load-more-btn"
        (click)="loadMore()"
        [disabled]="loading">
        <i *ngIf="loading" class="pi pi-spin pi-spinner mr-2"></i>
      </button>
    </div>
    
    <!-- Loading More Indicator -->
    <div *ngIf="loading && notifications.length > 0" class="loading-more">
      <i class="pi pi-spin pi-spinner"></i>
      <span>Loading more...</span>
    </div>
  </div>
</p-overlayPanel>