<!-- src/app/components/messaging/notifications/notifications.component.html -->

<!-- Notification Bell Button -->
<div class="notification-wrapper">
  <p-button
    #notificationButton
    icon="pi pi-bell"
    [badge]="badgeValue"
    [badgeClass]="hasUnreadNotifications() ? 'p-badge-danger' : ''"
    styleClass="p-button-text p-button-rounded"
    [outlined]="true"
    pTooltip="Notifications"
    tooltipPosition="bottom"
    (onClick)="toggleNotificationPanel($event)">
  </p-button>
</div>

<!-- Notification Panel -->
<p-overlayPanel 
  #notificationPanel
  [showCloseIcon]="true"
  [dismissable]="true"
  styleClass="notification-panel"
  [style]="{'width': '400px', 'max-width': '90vw'}"
  (onShow)="onPanelShow()"
  (onHide)="onPanelHide()">
  
  <!-- Header -->
  <ng-template pTemplate="header">
    <div class="flex justify-content-between align-items-center w-full px-3 py-2">
      <h3 class="m-0 text-lg font-semibold">Notifications</h3>
      
      <div class="flex gap-2">
        <!-- Refresh Button -->
        <p-button
          icon="pi pi-refresh"
          styleClass="p-button-text p-button-sm p-button-rounded"
          pTooltip="Refresh"
          [disabled]="loading"
          (onClick)="refreshNotifications()">
        </p-button>
        
        <!-- Mark All as Read -->
        <p-button
          *ngIf="hasUnreadNotifications()"
          icon="pi pi-check-square"
          label="Mark all read"
          styleClass="p-button-text p-button-sm"
          [disabled]="loading"
          (onClick)="markAllAsRead()">
        </p-button>
        
        <!-- Clear All -->
        <p-button
          *ngIf="hasNotifications()"
          icon="pi pi-trash"
          styleClass="p-button-text p-button-sm p-button-rounded p-button-danger"
          pTooltip="Clear all"
          [disabled]="loading"
          (onClick)="clearAllNotifications()">
        </p-button>
      </div>
    </div>
  </ng-template>

  <!-- Loading State -->
  <div *ngIf="loading && !hasNotifications()" class="p-4">
    <div class="flex flex-column gap-3">
      <div *ngFor="let i of [1,2,3]" class="flex gap-3">
        <p-skeleton shape="circle" size="3rem"></p-skeleton>
        <div class="flex-1">
          <p-skeleton width="100%" height="1rem" styleClass="mb-2"></p-skeleton>
          <p-skeleton width="80%" height="0.8rem"></p-skeleton>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="p-5 text-center">
    <i class="pi pi-exclamation-triangle text-4xl text-red-500 mb-3"></i>
    <p class="text-600 mb-3">{{ error }}</p>
    <p-button 
      label="Try Again" 
      icon="pi pi-refresh"
      styleClass="p-button-sm"
      (onClick)="retryLoading()">
    </p-button>
  </div>

  <!-- Notifications List -->
  <p-scrollPanel 
    *ngIf="!loading || hasNotifications()"
    [style]="{'height': hasNotifications() ? '400px' : 'auto', 'max-height': '60vh'}">
    
    <!-- Empty State -->
    <div 
      *ngIf="!hasNotifications() && !error"
      class="flex flex-column align-items-center justify-content-center p-5 text-center">
      <i class="pi pi-bell text-5xl text-300 mb-3"></i>
      <p class="text-600 m-0">{{ getEmptyStateMessage() }}</p>
    </div>

    <!-- Notification Items -->
    <div 
      *ngFor="let notification of notifications; trackBy: trackByNotificationId"
      class="notification-item"
      [class.unread]="!notification.isRead"
      (click)="onNotificationClick(notification)"
      pRipple>
      
      <div class="flex gap-3 p-3">
        <!-- Icon -->
        <div class="flex-shrink-0">
          <div 
            class="notification-icon"
            [style.color]="getNotificationIconColor(notification.type)">
            <i [class]="getNotificationIcon(notification.type)"></i>
          </div>
        </div>

        <!-- Content -->
        <div class="flex-1 min-w-0">
          <div class="flex justify-content-between align-items-start mb-1">
            <h4 class="notification-title" [class.font-semibold]="!notification.isRead">
              {{ notification.title }}
            </h4>
            <span class="notification-time">
              {{ formatTime(notification.createdAt) }}
            </span>
          </div>

          <p class="notification-content">
            {{ getShortContent(notification.content) }}
          </p>

          <!-- Related Info -->
          <div *ngIf="isPopulatedUser(notification.relatedUserId)" class="notification-meta mt-1">
            <span class="related-info">{{ getRelatedUsername(notification.relatedUserId) }}</span>
          </div>
          
          <div *ngIf="isPopulatedChat(notification.relatedChatId)" class="notification-meta mt-1">
            <span class="related-info">in {{ getRelatedChatName(notification.relatedChatId) }}</span>
          </div>

          <!-- Actions -->
          <div class="flex gap-2 mt-2">
            <!-- Mark as Read Button -->
            <p-button
              *ngIf="!notification.isRead"
              icon="pi pi-check"
              label="Mark read"
              styleClass="p-button-text p-button-sm p-button-secondary"
              (onClick)="markAsRead(notification._id, $event)">
            </p-button>

            <!-- Delete Button -->
            <p-button
              icon="pi pi-trash"
              styleClass="p-button-text p-button-sm p-button-danger"
              pTooltip="Delete"
              (onClick)="deleteNotification($event, notification._id)">
            </p-button>
          </div>
        </div>

        <!-- Unread Indicator -->
        <div 
          *ngIf="!notification.isRead"
          class="unread-dot">
        </div>
      </div>
    </div>

    <!-- Load More -->
    <div *ngIf="hasMore && !loading" class="p-3 text-center">
      <p-button 
        label="Load More" 
        icon="pi pi-chevron-down"
        styleClass="p-button-text"
        (onClick)="loadMore()">
      </p-button>
    </div>

    <!-- Loading More -->
    <div *ngIf="loading && hasNotifications()" class="p-3 text-center">
      <i class="pi pi-spin pi-spinner text-primary"></i>
      <span class="ml-2 text-600">Loading more...</span>
    </div>
  </p-scrollPanel>
</p-overlayPanel>